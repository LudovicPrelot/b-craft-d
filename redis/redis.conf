# =====================================================
# B-CraftD v3.0 - Redis Configuration
# Redis 7.2+
# =====================================================

# Bind sur toutes les interfaces (Docker)
bind 0.0.0.0

# Port par défaut
port 6379

# Protection par mot de passe (défini via variable env REDIS_PASSWORD)
# requirepass redis_secure_pass

# =====================================================
# PERSISTENCE
# =====================================================

# RDB (Redis Database) - Snapshots
# Sauvegarder après 900s si au moins 1 clé a changé
save 900 1
# Sauvegarder après 300s si au moins 10 clés ont changé
save 300 10      
# Sauvegarder après 60s si au moins 10000 clés ont changé
save 60 10000    

# Nom du fichier RDB
dbfilename dump.rdb

# Répertoire de persistence
dir /data

# Compression RDB
rdbcompression yes

# Checksum RDB
rdbchecksum yes

# AOF (Append Only File) - Mode hybride recommandé
appendonly yes
appendfilename "appendonly.aof"

# Stratégie de sync AOF
# Compromis performance/sécurité
appendfsync everysec   

# Rewrite AOF automatique
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# =====================================================
# MÉMOIRE
# =====================================================

# Limite mémoire (ajuster selon votre serveur)
maxmemory 512mb

# Politique d'éviction quand maxmemory est atteinte
# allkeys-lru = Éviction LRU (Least Recently Used) de toutes les clés
maxmemory-policy allkeys-lru

# Samples pour l'algorithme LRU
maxmemory-samples 5

# =====================================================
# SÉCURITÉ
# =====================================================

# Désactiver les commandes dangereuses
rename-command CONFIG ""
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command SHUTDOWN ""

# Timeout des connexions inactives (secondes)
timeout 300

# Keepalive TCP
tcp-keepalive 300

# =====================================================
# PERFORMANCE
# =====================================================

# Nombre max de connexions simultanées
maxclients 10000

# Lazy free (libération mémoire en arrière-plan)
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Threading I/O (Redis 6+)
io-threads 4
io-threads-do-reads yes

# =====================================================
# LOGGING
# =====================================================

# Niveau de log: debug, verbose, notice, warning
loglevel notice

# Fichier de log (vide = stdout)
logfile ""

# Syslog
syslog-enabled no

# =====================================================
# SLOW LOG
# =====================================================

# Log des commandes lentes (microsecondes)
slowlog-log-slower-than 10000

# Nombre max d'entrées dans le slow log
slowlog-max-len 128

# =====================================================
# DATABASES
# =====================================================

# Nombre de bases de données (0-15)
databases 16

# =====================================================
# OPTIMISATIONS B-CRAFTD
# =====================================================

# Hash optimisations (pour petites structures)
hash-max-listpack-entries 512
hash-max-listpack-value 64

# List optimisations
list-max-listpack-size -2
list-compress-depth 0

# Set optimisations
set-max-intset-entries 512
set-max-listpack-entries 128
set-max-listpack-value 64

# Zset optimisations (leaderboard)
zset-max-listpack-entries 128
zset-max-listpack-value 64

# =====================================================
# KEYSPACE NOTIFICATIONS (pour invalidation cache)
# =====================================================

# Activer les notifications pour les expirations et évictions
notify-keyspace-events "Ex"
# E = Keyevent events
# x = Expired events

# =====================================================
# CLIENT OUTPUT BUFFER
# =====================================================

# Limites pour éviter les clients lents
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# =====================================================
# REPLICATION (pour production multi-serveur)
# =====================================================

# Désactivé par défaut (mode standalone)
# replicaof <masterip> <masterport>
# masterauth <master-password>

# =====================================================
# CLUSTER (pour scalabilité horizontale)
# =====================================================

# Désactivé par défaut
# cluster-enabled no

# =====================================================
# LATENCY MONITORING
# =====================================================

# Monitor les opérations longues
latency-monitor-threshold 100

# =====================================================
# FIN DE CONFIGURATION
# =====================================================
{% extends "base.html" %}
{% block title %}Devices{% endblock %}

{% block content %}
<h1>Devices</h1>
<button id="refresh">Voir mes devices</button>
<ul id="devicesList"></ul>

<form id="addDeviceForm">
  <input name="device_id" placeholder="device id">
  <button>Ajouter device</button>
</form>
{% endblock %}

{% block scripts %}
<script>
async function headers(){ return {"Authorization":"Bearer "+localStorage.getItem('access_token')} }
document.getElementById('refresh').onclick = async ()=>{
  const r = await fetch('/api/devices/', { headers: await headers() });
  const j = await r.json();
  const ul = document.getElementById('devicesList');
  ul.innerHTML = '';
  (j.devices || []).forEach(d => { const li = document.createElement('li'); li.textContent = d; ul.appendChild(li); });
};
document.getElementById('addDeviceForm').onsubmit = async (e)=>{
  e.preventDefault();
  const id = new FormData(e.target).get('device_id');
  const r = await fetch('/api/devices/add?device_id='+encodeURIComponent(id), { method:'POST', headers: await headers() });
  if(!r.ok){ alert('Erreur'); return; }
  alert('Device ajout√©'); document.getElementById('refresh').click();
};
</script>
{% endblock %}
